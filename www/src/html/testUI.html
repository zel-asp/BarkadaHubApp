async function renderPost(post, position = "beforeend") {
if (!post.id || displayedPostIds.has(post.id)) return;

// Get the latest avatar from profile
let avatar = '../images/defaultAvatar.jpg';
const { data: profile } = await supabaseClient
.from('profile')
.select('avatar_url')
.eq('id', post.user_id)
.single();
if (profile?.avatar_url) avatar = profile.avatar_url;

const owner = (userId === post.user_id);
const relativeTime = formatRelativeTime(post.created_at);

const html = uploadedPost(
avatar,
owner,
post.user_name,
relativeTime,
post.content,
post.media_url,
post.media_type,
post.id,
post.likes_count,
post.comment_count,
post.is_liked_by_user
);

postsContainer.insertAdjacentHTML(position, html);
displayedPostIds.add(post.id);

setTimeout(() => {
initEllipsisButtons();
initLikeButtons();
}, 100);
}


async function renderPost(post, position = "beforeend") {
if (!post.id || displayedPostIds.has(post.id)) return;

// Get current user
const { data: userData } = await supabaseClient.auth.getUser();
const owner = userData.user.id === post.user_id;
let isLikedByUser = false;

if (userData?.user) {
const { data: userLike } = await supabaseClient
.from('post_likes')
.select('id')
.eq('post_id', post.id)
.eq('user_id', userData.user.id)
.maybeSingle();
isLikedByUser = !!userLike;
}

// Count total likes
const { count: totalLikes } = await supabaseClient
.from('post_likes')
.select('*', { count: 'exact', head: true })
.eq('post_id', post.id);

// Count total comments
const { count: commentCount } = await supabaseClient
.from('post_comments')
.select('*', { count: 'exact', head: true })
.eq('post_id', post.id);

const relativeTime = formatRelativeTime(post.created_at);
const html = uploadedPost(
post.avatar_url,
owner,
post.user_name,
relativeTime,
post.content,
post.media_url,
post.media_type,
post.id,
totalLikes,
commentCount,
isLikedByUser
);

postsContainer.insertAdjacentHTML(position, html);
displayedPostIds.add(post.id);

// Initialize buttons after DOM is updated
setTimeout(() => {
initEllipsisButtons();
initLikeButtons();
}, 100);
}